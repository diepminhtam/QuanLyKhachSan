@model QuanLiKhachSan.ViewModels.Admin.RoomsViewModel
@{
    ViewData["Title"] = "Quản lý phòng";
    Layout = "_AdminLayout";
}

@functions{
    private string GetStatusBadge(string status)
    {
        return status?.ToLower() switch
        {
            "available" => "badge bg-success",
            "occupied" => "badge bg-warning text-dark",
            "maintenance" => "badge bg-danger",
            "cleaning" => "badge bg-info text-white",
            _ => "badge bg-secondary"
        };
    }
}

<div class="admin-rooms container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0">Quản lý phòng</h1>
            <small class="text-muted">Danh sách phòng, tìm kiếm, chỉnh sửa và quản lý trạng thái.</small>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-primary" href="@Url.Action("AddRoom", "Admin")"><i class="fas fa-plus me-1"></i> Thêm phòng mới</a>
            <button class="btn btn-outline-secondary" id="refreshBtn"><i class="fas fa-sync-alt"></i></button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3 mb-2">
            <div class="card shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Phòng trống</small>
                        <h4 class="mb-0">@Model.AvailableCount</h4>
                    </div>
                    <i class="fas fa-check-circle fa-2x text-success"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Đang sử dụng</small>
                        <h4 class="mb-0">@Model.OccupiedCount</h4>
                    </div>
                    <i class="fas fa-bed fa-2x text-warning"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Bảo trì</small>
                        <h4 class="mb-0">@Model.MaintenanceCount</h4>
                    </div>
                    <i class="fas fa-tools fa-2x text-danger"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Đang dọn dẹp</small>
                        <h4 class="mb-0">@Model.CleaningCount</h4>
                    </div>
                    <i class="fas fa-broom fa-2x text-info"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form id="roomSearchForm" method="get" class="row g-2 align-items-end">
                <div class="col-lg-3">
                    <label class="form-label">Tìm kiếm</label>
                    <input class="form-control" name="search" value="@Context.Request.Query["search"]" placeholder="Tên phòng" />
                </div>
                <div class="col-lg-3">
                    <label class="form-label">Loại phòng</label>
                    <select class="form-select" name="roomType">
                        <option value="">Tất cả loại phòng</option>
                        @{ var types = (Model.Rooms ?? new List<QuanLiKhachSan.ViewModels.Admin.RoomItemViewModel>()).Select(r=>r.RoomType).Where(x=>!string.IsNullOrEmpty(x)).Distinct().OrderBy(x=>x).ToList(); }
                        @foreach(var t in types){
                            if(Context.Request.Query["roomType"]==t){
                                <option value="@t" selected>@t</option>
                            } else {
                                <option value="@t">@t</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-lg-2">
                    <label class="form-label">Trạng thái</label>
                    <select class="form-select" name="status">
                        <option value="">Tất cả trạng thái</option>
                        @if(Context.Request.Query["status"]=="available"){ <option value="available" selected>Trống</option> } else { <option value="available">Trống</option> }
                        @if(Context.Request.Query["status"]=="occupied"){ <option value="occupied" selected>Đang sử dụng</option> } else { <option value="occupied">Đang sử dụng</option> }
                        @if(Context.Request.Query["status"]=="maintenance"){ <option value="maintenance" selected>Bảo trì</option> } else { <option value="maintenance">Bảo trì</option> }
                        @if(Context.Request.Query["status"]=="cleaning"){ <option value="cleaning" selected>Đang dọn dẹp</option> } else { <option value="cleaning">Đang dọn dẹp</option> }
                    </select>
                </div>
                <div class="col-lg-2">
                    <label class="form-label">Sắp xếp</label>
                    <select class="form-select" name="sortBy">
                        @if(Context.Request.Query["sortBy"]=="name"){ <option value="name" selected>Tên</option> } else { <option value="name">Tên</option> }
                        @if(Context.Request.Query["sortBy"]=="price"){ <option value="price" selected>Giá</option> } else { <option value="price">Giá</option> }
                        @if(Context.Request.Query["sortBy"]=="type"){ <option value="type" selected>Loại</option> } else { <option value="type">Loại</option> }
                    </select>
                </div>

                <input type="hidden" name="page" id="currentPage" value="@(Context.Request.Query["page"].ToString()==""?"1":Context.Request.Query["page"].ToString())" />

                <div class="col-auto">
                    <button class="btn btn-primary">Tìm kiếm</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width:40px"><input id="selectAll" type="checkbox" /></th>
                            <th>Hình</th>
                            <th>Tên phòng</th>
                            <th>Loại</th>
                            <th class="text-end">Giá/đêm</th>
                            <th>Sức chứa</th>
                            <th>Trạng thái</th>
                            <th>Tầng</th>
                            <th>Đánh giá</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @if(Model.Rooms != null && Model.Rooms.Any()){
                            foreach(var room in Model.Rooms){
                                <tr data-id="@room.Id">
                                    <td>
                                        <div class="form-check"><input class="form-check-input room-checkbox" type="checkbox" value="@room.Id" /></div>
                                    </td>
                                    <td>
                                        <div class="room-image">
                                            <img src="@(string.IsNullOrEmpty(room.ImageUrl)?"/images/placeholder-room.svg":room.ImageUrl)" alt="@room.Name" />
                                        </div>
                                    </td>
                                    <td><a href="@Url.Action("EditRoom", "Admin", new { id = room.Id })">@room.Name</a></td>
                                    <td>@room.RoomType</td>
                                    <td class="text-end">@room.PricePerNight.ToString("N0") VNĐ</td>
                                    <td>@room.Capacity</td>
                                    <td><span class="@GetStatusBadge(room.Status)">@room.Status</span></td>
                                    <td>@room.Floor</td>
                                    <td>
                                        <div class="room-rating"><i class="fas fa-star"></i> @room.Rating.ToString("0.0")</div>
                                    </td>
                                    <td>
                                        <div class="d-flex">
                                            <a class="btn btn-sm btn-outline-primary me-1" href="@Url.Action("EditRoom", "Admin", new { id = room.Id })"><i class="fas fa-edit"></i></a>
                                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteRoomModal" data-room-id="@room.Id" data-room-name="@room.Name"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        } else {
                            <tr><td colspan="10" class="text-center py-4 text-muted">Không có phòng nào.</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer">
            <div class="d-flex align-items-center justify-content-between">
                <div><small class="text-muted">Hiển thị <strong>@(Model.Rooms?.Count() ?? 0)</strong> phòng</small></div>
                <div>
                    <nav>
                        <ul class="pagination mb-0">
                            <li class="page-item @(Context.Request.Query["page"]=="1"||string.IsNullOrEmpty(Context.Request.Query["page"])?"disabled":"")">
                                <a class="page-link page-link-nav" href="#" data-page="@((Context.Request.Query["page"].ToString()==""?1:int.Parse(Context.Request.Query["page"].ToString())-1))"><i class="fas fa-angle-left"></i></a>
                            </li>
                            @for(int i=1;i<=5;i++){
                                <li class="page-item @(Context.Request.Query["page"]==i.ToString()?"active":"")"><a class="page-link page-link-nav" href="#" data-page="@i">@i</a></li>
                            }
                            <li class="page-item"><a class="page-link page-link-nav" href="#" data-page="@((Context.Request.Query["page"].ToString()==""?1:int.Parse(Context.Request.Query["page"].ToString())+1))"><i class="fas fa-angle-right"></i></a></li>
                        </ul>
                    </nav>
                </div>
                <div>
                    <select class="form-select form-select-sm" id="pageSizeSelect">
                        <option value="10">10 / trang</option>
                        <option value="25">25 / trang</option>
                        <option value="50">50 / trang</option>
                        <option value="100">100 / trang</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="bulk-actions-bar fixed-bottom bg-white border-top p-3 d-none">
        <div class="d-flex align-items-center">
            <div class="me-3"><span class="selected-count">0</span> phòng đã chọn</div>
            <div>
                <button class="btn btn-outline-success me-2" id="bulkAvailable">Đánh dấu trống</button>
                <button class="btn btn-outline-warning me-2" id="bulkMaintenance">Đánh dấu bảo trì</button>
                <button class="btn btn-outline-danger me-2" id="bulkDelete">Xóa</button>
            </div>
            <div class="ms-auto"><button class="btn btn-sm btn-secondary" id="clearSelection">Bỏ chọn</button></div>
        </div>
    </div>

    <!-- Delete Room Modal -->
    <div class="modal fade" id="deleteRoomModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Xác nhận xóa phòng</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa phòng <strong id="deleteRoomName">?</strong>?</p>
                    <div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Thao tác không thể hoàn tác.</div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button class="btn btn-danger" id="confirmDeleteBtn">Xác nhận xóa</button>
                </div>
            </div>
        </div>
    </div>

</div>

@Html.AntiForgeryToken()

@section Scripts{
    <script>
        (function(){
            const getToken = ()=>document.querySelector('input[name="__RequestVerificationToken"]').value;
            const headers = ()=>({ 'Content-Type':'application/json', 'RequestVerificationToken': getToken() });

            function updateBulkBar(){
                const cnt = document.querySelectorAll('.room-checkbox:checked').length;
                document.querySelector('.selected-count').textContent = cnt;
                document.querySelector('.bulk-actions-bar').classList.toggle('d-none', cnt===0);
            }

            document.addEventListener('DOMContentLoaded', function(){
                document.getElementById('selectAll')?.addEventListener('change', function(){
                    document.querySelectorAll('tbody .room-checkbox').forEach(cb=>cb.checked=this.checked);
                    updateBulkBar();
                });

                document.querySelectorAll('tbody').forEach(tb=>tb.addEventListener('change', function(e){ if(e.target && e.target.matches('.room-checkbox')) updateBulkBar(); }));

                document.getElementById('clearSelection')?.addEventListener('click', function(){ document.querySelectorAll('.room-checkbox').forEach(cb=>cb.checked=false); document.getElementById('selectAll').checked=false; updateBulkBar(); });

                document.getElementById('refreshBtn')?.addEventListener('click', ()=>location.reload());

                // Delete modal population
                var deleteRoomId = null;
                var deleteModal = document.getElementById('deleteRoomModal');
                deleteModal?.addEventListener('show.bs.modal', function(ev){
                    const btn = ev.relatedTarget; if(!btn) return;
                    deleteRoomId = btn.getAttribute('data-room-id');
                    const name = btn.getAttribute('data-room-name') || '?';
                    document.getElementById('deleteRoomName').textContent = name;
                });

                document.getElementById('confirmDeleteBtn')?.addEventListener('click', function(){
                    if(!deleteRoomId){ alert('Không có phòng để xóa'); return; }
                    fetch('/Admin/DeleteRoom/' + deleteRoomId, { method:'POST', headers: headers() })
                        .then(r=>r.json()).then(j=>{ if(j.success){ alert(j.message||'Đã xóa'); location.reload(); } else alert(j.message||'Lỗi'); })
                        .catch(()=>alert('Lỗi mạng'));
                });

                // Bulk actions
                document.getElementById('bulkAvailable')?.addEventListener('click', function(){
                    const ids = Array.from(document.querySelectorAll('.room-checkbox:checked')).map(i=>parseInt(i.value));
                    if(!ids.length){ alert('Vui lòng chọn phòng'); return; }
                    if(!confirm(`Đánh dấu ${ids.length} phòng là trống?`)) return;
                    fetch('/Admin/BulkUpdateRooms', { method:'POST', headers: headers(), body: JSON.stringify({ ids: ids, status: 'available' }) })
                        .then(r=>r.json()).then(j=>{ if(j.success){ alert(j.message||'Đã cập nhật'); location.reload(); } else alert(j.message||'Lỗi'); })
                        .catch(()=>alert('Lỗi mạng'));
                });

                document.getElementById('bulkMaintenance')?.addEventListener('click', function(){
                    const ids = Array.from(document.querySelectorAll('.room-checkbox:checked')).map(i=>parseInt(i.value));
                    if(!ids.length){ alert('Vui lòng chọn phòng'); return; }
                    if(!confirm(`Đánh dấu ${ids.length} phòng là bảo trì?`)) return;
                    fetch('/Admin/BulkUpdateRooms', { method:'POST', headers: headers(), body: JSON.stringify({ ids: ids, status: 'maintenance' }) })
                        .then(r=>r.json()).then(j=>{ if(j.success){ alert(j.message||'Đã cập nhật'); location.reload(); } else alert(j.message||'Lỗi'); })
                        .catch(()=>alert('Lỗi mạng'));
                });

                document.getElementById('bulkDelete')?.addEventListener('click', function(){
                    const ids = Array.from(document.querySelectorAll('.room-checkbox:checked')).map(i=>parseInt(i.value));
                    if(!ids.length){ alert('Vui lòng chọn phòng'); return; }
                    if(!confirm(`Xóa ${ids.length} phòng?`)) return;
                    fetch('/Admin/BulkDeleteRooms', { method:'POST', headers: headers(), body: JSON.stringify(ids) })
                        .then(r=>r.json()).then(j=>{ if(j.success){ alert(j.message||'Đã xóa'); location.reload(); } else alert(j.message||'Lỗi'); })
                        .catch(()=>alert('Lỗi mạng'));
                });

                // Pagination links
                document.querySelectorAll('.page-link-nav').forEach(a=>a.addEventListener('click', function(e){ e.preventDefault(); document.getElementById('currentPage').value = this.getAttribute('data-page')||'1'; document.getElementById('roomSearchForm').submit(); }));

            });
        })();
    </script>
}

@section Styles{
    <style>
        .room-image{width:64px;height:48px;overflow:hidden;border-radius:6px}
        .room-image img{width:100%;height:100%;object-fit:cover}
        .room-rating i{color:#f6c23e;margin-right:4px}
        .bulk-actions-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;padding:0.75rem 1rem;border-top:1px solid #e9ecef;z-index:1030}
    </style>
}