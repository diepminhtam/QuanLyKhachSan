@model QuanLiKhachSan.ViewModels.Admin.BookingsViewModel
@{
    ViewData["Title"] = "Quản lý đặt phòng";
    Layout = "_AdminLayout";
}

@functions {
    private string GetInitials(string fullName)
    {
        if (string.IsNullOrEmpty(fullName)) return "NN";
        var names = fullName.Split(' ');
        if (names.Length >= 2)
            return $"{names[0][0]}{names[^1][0]}".ToUpper();
        return fullName.Length >= 2 ? fullName[..2].ToUpper() : fullName.ToUpper();
    }

    private string GetStatusBadgeClass(string status)
    {
        return status?.ToLower() switch
        {
            "chờ xác nhận" or "pending" => "bg-warning text-dark",
            "đã xác nhận" or "confirmed" => "bg-primary",
            "hoàn thành" or "completed" => "bg-success",
            "đã hủy" or "cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetPaymentStatusBadgeClass(string paymentStatus)
    {
        return paymentStatus?.ToLower() switch
        {
            "đã thanh toán" or "paid" => "bg-success",
            "chờ thanh toán" or "pending" => "bg-warning text-dark",
            "thất bại" or "failed" => "bg-danger",
            "hoàn tiền" or "refunded" => "bg-info",
            _ => "bg-secondary"
        };
    }
}

<div class="admin-bookings container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0">Quản lý đặt phòng</h1>
            <small class="text-muted">Quản lý, lọc và xử lý các đơn đặt phòng.</small>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" id="refreshBtn" title="Làm mới danh sách"><i class="fas fa-sync-alt"></i></button>
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">Xuất</button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="@Url.Action("Export", "Admin", new { format = "excel" })">Excel</a></li>
                    <li><a class="dropdown-item" href="@Url.Action("Export", "Admin", new { format = "pdf" })">PDF</a></li>
                    <li><a class="dropdown-item" href="@Url.Action("Export", "Admin", new { format = "csv" })">CSV</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Summary cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Chờ xác nhận</small>
                        <h4 class="mb-0">@Model.PendingCount</h4>
                    </div>
                    <i class="fas fa-hourglass-half fa-2x text-warning"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Đã xác nhận</small>
                        <h4 class="mb-0">@Model.ConfirmedCount</h4>
                    </div>
                    <i class="fas fa-calendar-check fa-2x text-primary"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Hoàn thành</small>
                        <h4 class="mb-0">@Model.CompletedCount</h4>
                    </div>
                    <i class="fas fa-check-circle fa-2x text-success"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Đã hủy</small>
                        <h4 class="mb-0">@Model.CancelledCount</h4>
                    </div>
                    <i class="fas fa-times-circle fa-2x text-danger"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="bookingSearchForm" method="get" class="row g-2 align-items-end">
                <div class="col-lg-3">
                    <label class="form-label">Mã đặt phòng</label>
                    <input type="text" class="form-control" name="bookingId" value="@Context.Request.Query["bookingId"]" />
                </div>
                <div class="col-lg-3">
                    <label class="form-label">Tên khách hàng</label>
                    <input type="text" class="form-control" name="customerName" value="@Context.Request.Query["customerName"]" />
                </div>
                <div class="col-lg-2">
                    <label class="form-label">Trạng thái</label>
                    <select class="form-select" name="status">
                        <option value="">Tất cả trạng thái</option>
                        @if (Context.Request.Query["status"] == "pending") {
                            <option value="pending" selected>Chờ xác nhận</option>
                        } else {
                            <option value="pending">Chờ xác nhận</option>
                        }

                        @if (Context.Request.Query["status"] == "confirmed") {
                            <option value="confirmed" selected>Đã xác nhận</option>
                        } else {
                            <option value="confirmed">Đã xác nhận</option>
                        }

                        @if (Context.Request.Query["status"] == "completed") {
                            <option value="completed" selected>Hoàn thành</option>
                        } else {
                            <option value="completed">Hoàn thành</option>
                        }

                        @if (Context.Request.Query["status"] == "cancelled") {
                            <option value="cancelled" selected>Đã hủy</option>
                        } else {
                            <option value="cancelled">Đã hủy</option>
                        }
                    </select>
                </div>
                <div class="col-lg-2">
                    <label class="form-label">Từ ngày</label>
                    <input type="date" class="form-control" name="startDate" value="@Context.Request.Query["startDate"]" />
                </div>
                <div class="col-lg-2">
                    <label class="form-label">Đến ngày</label>
                    <input type="date" class="form-control" name="endDate" value="@Context.Request.Query["endDate"]" />
                </div>

                <input type="hidden" name="page" id="currentPage" value="@(Context.Request.Query["page"].ToString()==""?"1":Context.Request.Query["page"].ToString())" />

                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">Tìm kiếm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Table -->
    <div class="card mb-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width:40px"><input id="selectAll" type="checkbox" /></th>
                            <th>Mã</th>
                            <th>Khách</th>
                            <th>Phòng</th>
                            <th>Nhận</th>
                            <th>Trả</th>
                            <th>Khách</th>
                            <th class="text-end">Tổng</th>
                            <th>Trạng thái</th>
                            <th>Thanh toán</th>
                            <th style="width:160px" class="text-end">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Bookings != null && Model.Bookings.Any())
                        {
                            foreach (var booking in Model.Bookings)
                            {
                                <tr data-id="@booking.Id">
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input booking-checkbox" type="checkbox" value="@booking.Id" />
                                        </div>
                                    </td>
                                    <td><a href="@Url.Action("BookingDetails", "Admin", new { id = booking.Id })" class="booking-link">@booking.BookingNumber</a></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle me-2">@GetInitials(booking.CustomerName)</div>
                                            <div>
                                                <div class="fw-semibold">@booking.CustomerName</div>
                                                <small class="text-muted">@booking.CustomerEmail</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>@booking.RoomName</td>
                                    <td>@booking.CheckInDate.ToString("dd/MM/yyyy")</td>
                                    <td>@booking.CheckOutDate.ToString("dd/MM/yyyy")</td>
                                    <td>@booking.GuestCount</td>
                                    <td class="text-end">@booking.TotalPrice.ToString("N0") VNĐ</td>
                                    <td><span class="badge @GetStatusBadgeClass(booking.Status ?? "")">@booking.Status</span></td>
                                    <td><span class="badge @GetPaymentStatusBadgeClass(booking.PaymentStatus ?? "")">@booking.PaymentStatus</span></td>
                                    <td class="text-end">
                                        <a class="btn btn-sm btn-outline-secondary booking-action-btn me-1" href="@Url.Action("BookingDetails", "Admin", new { id = booking.Id })" title="Chi tiết" aria-label="Chi tiết" data-bs-toggle="tooltip" data-bs-placement="top"><i class="fas fa-eye"></i></a>
                                        @if (!(booking.Status?.ToLower() == "đã xác nhận" || booking.Status?.ToLower() == "confirmed"))
                                        {
                                            <button type="button" class="btn btn-sm btn-success booking-action-btn confirm-action me-1" data-id="@booking.Id" title="Xác nhận" aria-label="Xác nhận đơn" data-bs-toggle="tooltip" data-bs-placement="top"><i class="fas fa-check"></i></button>
                                        }
                                        <button type="button" class="btn btn-sm btn-danger booking-action-btn cancel-action" data-id="@booking.Id" title="Hủy" aria-label="Hủy đơn" data-bs-toggle="tooltip" data-bs-placement="top"><i class="fas fa-times"></i></button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="11" class="text-center py-4">
                                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                    <div class="text-muted">Không có đơn đặt phòng nào.</div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <span class="text-muted">Hiển thị <strong>@(Model.Bookings?.Count() ?? 0)</strong> mục</span>
                </div>

                <div>
                    <nav>
                        <ul class="pagination mb-0">
                            <li class="page-item @(Context.Request.Query["page"]=="1" || string.IsNullOrEmpty(Context.Request.Query["page"]) ? "disabled":"")">
                                <a class="page-link page-link-nav" href="#" data-page="@((Context.Request.Query["page"].ToString()==""?1:int.Parse(Context.Request.Query["page"].ToString()) - 1))"><i class="fas fa-angle-left"></i></a>
                            </li>
                            @for (int i = 1; i <= 5; i++)
                            {
                                <li class="page-item @(Context.Request.Query["page"]==i.ToString()?"active":"")"><a class="page-link page-link-nav" href="#" data-page="@i">@i</a></li>
                            }
                            <li class="page-item">
                                <a class="page-link page-link-nav" href="#" data-page="@((Context.Request.Query["page"].ToString()==""?1:int.Parse(Context.Request.Query["page"].ToString()) + 1))"><i class="fas fa-angle-right"></i></a>
                            </li>
                        </ul>
                    </nav>
                </div>

                <div>
                    <select class="form-select form-select-sm" id="pageSizeSelect">
                        <option value="10">10 / trang</option>
                        <option value="25">25 / trang</option>
                        <option value="50">50 / trang</option>
                        <option value="100">100 / trang</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk actions bar -->
    <div class="bulk-actions-bar fixed-bottom bg-white border-top p-3 d-none">
        <div class="d-flex align-items-center">
            <div class="me-3"><span class="selected-count">0</span> mục đã chọn</div>
            <div>
                <button class="btn btn-outline-primary me-2" id="bulkConfirm">Xác nhận</button>
                <button class="btn btn-outline-danger" id="bulkCancel">Hủy</button>
            </div>
            <div class="ms-auto">
                <button class="btn btn-sm btn-secondary" id="clearSelection">Bỏ chọn</button>
            </div>
        </div>
    </div>

    <!-- Confirmation modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmationMessage">Bạn có chắc chắn muốn thực hiện thao tác này?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button class="btn btn-primary" id="confirmAction">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

</div>

@* Anti-forgery token for AJAX POSTs *@
@Html.AntiForgeryToken()

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
        (function(){
            const getRequestToken = () => document.querySelector('input[name="__RequestVerificationToken"]').value;

            const buildHeaders = (extra) => Object.assign({
                'Content-Type': 'application/json',
                'RequestVerificationToken': getRequestToken()
            }, extra || {});

            function toast(msg){ alert(msg); }

            function updateBulkBar(){
                const cnt = document.querySelectorAll('.booking-checkbox:checked').length;
                document.querySelector('.selected-count').textContent = cnt;
                document.querySelector('.bulk-actions-bar').classList.toggle('d-none', cnt===0);
            }

            document.addEventListener('DOMContentLoaded', function(){
                // daterange (optional) initialize if library available
                if(window.jQuery && $.fn.daterangepicker){
                    $('#daterange').daterangepicker({
                        locale:{format:'DD/MM/YYYY'}, opens:'left'
                    });
                }

                // initialize bootstrap tooltips (if bootstrap loaded)
                try{
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });
                } catch(e){ /* ignore if bootstrap not present */ }

                // select all
                document.getElementById('selectAll')?.addEventListener('change', function(){
                    document.querySelectorAll('tbody .booking-checkbox').forEach(cb => cb.checked = this.checked);
                    updateBulkBar();
                });

                document.querySelectorAll('tbody').forEach(tb => tb.addEventListener('change', function(e){
                    if(e.target && e.target.matches('.booking-checkbox')) updateBulkBar();
                }));

                document.getElementById('clearSelection')?.addEventListener('click', function(){
                    document.querySelectorAll('.booking-checkbox').forEach(cb=>cb.checked=false);
                    document.getElementById('selectAll').checked = false;
                    updateBulkBar();
                });

                // confirm / cancel actions (delegated)
                document.body.addEventListener('click', function(e){
                    if(e.target.closest('.confirm-action')){
                        e.preventDefault();
                        const id = e.target.closest('[data-id]')?.getAttribute('data-id');
                        if(!id) return; if(!confirm('Xác nhận đơn này?')) return;
                        fetch('/Admin/ConfirmBooking/' + id, { method: 'POST', headers: buildHeaders() })
                            .then(r => r.json()).then(j => { if(j.success){ toast(j.message); location.reload(); } else toast(j.message||'Lỗi'); })
                            .catch(()=>toast('Lỗi mạng'));
                    }
                    if(e.target.closest('.cancel-action')){
                        e.preventDefault();
                        const id = e.target.closest('[data-id]')?.getAttribute('data-id');
                        if(!id) return; if(!confirm('Hủy đơn này?')) return;
                        fetch('/Admin/CancelBooking/' + id, { method: 'POST', headers: buildHeaders() })
                            .then(r => r.json()).then(j => { if(j.success){ toast(j.message); location.reload(); } else toast(j.message||'Lỗi'); })
                            .catch(()=>toast('Lỗi mạng'));
                    }
                });

                // Bulk actions
                document.getElementById('bulkConfirm')?.addEventListener('click', function(){
                    const ids = Array.from(document.querySelectorAll('.booking-checkbox:checked')).map(i=>parseInt(i.value));
                    if(!ids.length){ toast('Vui lòng chọn mục.'); return; }
                    if(!confirm(`Xác nhận ${ids.length} đơn?`)) return;
                    fetch('/Admin/BulkConfirm', { method: 'POST', headers: buildHeaders(), body: JSON.stringify(ids) })
                        .then(r=>r.json()).then(j=>{ if(j.success){ toast(j.message); location.reload(); } else toast(j.message||'Lỗi'); })
                        .catch(()=>toast('Lỗi mạng'));
                });

                document.getElementById('bulkCancel')?.addEventListener('click', function(){
                    const ids = Array.from(document.querySelectorAll('.booking-checkbox:checked')).map(i=>parseInt(i.value));
                    if(!ids.length){ toast('Vui lòng chọn mục.'); return; }
                    if(!confirm(`Hủy ${ids.length} đơn?`)) return;
                    fetch('/Admin/BulkCancel', { method: 'POST', headers: buildHeaders(), body: JSON.stringify(ids) })
                        .then(r=>r.json()).then(j=>{ if(j.success){ toast(j.message); location.reload(); } else toast(j.message||'Lỗi'); })
                        .catch(()=>toast('Lỗi mạng'));
                });

                // Refresh
                document.getElementById('refreshBtn')?.addEventListener('click', function(){ location.reload(); });

                // Pagination links: set hidden page and submit
                document.querySelectorAll('.page-link-nav').forEach(function(a){
                    a.addEventListener('click', function(e){
                        e.preventDefault();
                        const p = this.getAttribute('data-page') || '1';
                        document.getElementById('currentPage').value = p;
                        document.getElementById('bookingSearchForm').submit();
                    });
                });

            });
        })();
    </script>
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="~/css/admin-bookings.css" asp-append-version="true" />
}