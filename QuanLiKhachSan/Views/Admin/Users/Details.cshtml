@model QuanLiKhachSan.ViewModels.Admin.UserDetailViewModel
@{
    // Use layout when the view is requested directly (non-AJAX), keep null for partial/AJAX requests
    var isAjax = (Context?.Request?.Headers["X-Requested-With"].ToString() ?? "") == "XMLHttpRequest";
    Layout = isAjax ? null : "_AdminLayout";
}

<link rel="stylesheet" href="~/css/admin-ui.css" />

<div class="user-detail admin-user-details p-3">
    <div class="admin-card mb-4">
        <div class="card-body d-flex gap-3 align-items-center">
            <div class="user-avatar rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:96px;height:96px;font-size:32px">@Model.Initials</div>
            <div class="flex-grow-1">
                <h3 class="mb-1">@Model.FullName</h3>
                <div class="text-muted">@Model.Email &nbsp;•&nbsp; @Model.Phone</div>
                <div class="mt-2">
                    <span class="badge bg-primary me-1">@Model.UserType</span>
                    <span class="badge bg-secondary">@Model.Status</span>
                </div>
            </div>
            <div class="text-end">
                <div class="admin-toolbar mb-2">
                    <a class="btn btn-sm btn-outline-primary" href="@Url.Action("Edit", "Admin", new { id = Model.UserId })" title="Sửa" data-bs-toggle="tooltip" data-bs-placement="top">Sửa</a>
                    <form method="post" action="/Admin/Users/ToggleLock/@Model.Id" class="d-inline">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Khoá / Mở khóa" data-bs-toggle="tooltip">Khoá</button>
                    </form>
                    <a class="btn btn-sm btn-outline-secondary" href="mailto:@Model.Email" title="Gửi email" data-bs-toggle="tooltip">Liên hệ</a>
                </div>
                <div class="small text-muted">ID: @Model.UserId</div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-4">
            <div class="admin-card mb-3">
                <div class="card-body">
                    <h6 class="mb-3">Thông tin nhanh</h6>
                    <div class="d-flex flex-column gap-2">
                        <div><strong>Đăng ký:</strong> @Model.RegisterDate.ToString("dd/MM/yyyy")</div>
                        <div><strong>Số điện thoại:</strong> @Model.Phone</div>
                        <div><strong>Địa chỉ:</strong> @Model.Address</div>
                        <div><strong>Điểm khách hàng:</strong> @Model.LoyaltyPoints</div>
                    </div>
                </div>
            </div>

            <div class="admin-card mb-3">
                <div class="card-body">
                    <h6 class="mb-3">Hoạt động gần đây</h6>
                    @if (Model.RecentActivities != null && Model.RecentActivities.Any())
                    {
                        <ul class="activity-timeline list-unstyled mb-0">
                            @foreach(var a in Model.RecentActivities)
                            {
                                <li class="d-flex mb-3">
                                    <div class="activity-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width:36px;height:36px;"><i class="fas fa-history"></i></div>
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">@a.Title</div>
                                        <div class="small text-muted">@a.Date.ToString("dd/MM/yyyy HH:mm")</div>
                                        <div class="small text-muted">@a.Description</div>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-muted">Không có hoạt động gần đây.</div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="row">
                <div class="col-md-4">
                    <div class="admin-card text-center py-3 mb-3">
                        <div class="small text-muted">Tổng chi tiêu</div>
                        <div class="value mt-1 fw-bold">@((Model.TotalSpending).ToString("N0")) VNĐ</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="admin-card text-center py-3 mb-3">
                        <div class="small text-muted">Số đơn</div>
                        <div class="value mt-1 fw-bold">@Model.BookingsCount</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="admin-card text-center py-3 mb-3">
                        <div class="small text-muted">Điểm</div>
                        <div class="value mt-1 fw-bold">@Model.LoyaltyPoints</div>
                    </div>
                </div>
            </div>

            <div class="admin-card mb-3">
                <div class="card-body">
                    <h6 class="mb-3">Đặt phòng gần đây</h6>
                    @if (Model.RecentBookings != null && Model.RecentBookings.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach(var b in Model.RecentBookings)
                            {
                                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                                    <div>
                                        <div class="fw-semibold">@b.RoomName</div>
                                        <div class="small text-muted">@b.BookingNumber • @b.CheckIn.ToString("dd/MM/yyyy") - @b.CheckOut.ToString("dd/MM/yyyy")</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold">@b.TotalPrice.ToString("N0") VNĐ</div>
                                        <div><span class="badge @(b.Status=="Confirmed"?"bg-success":"bg-secondary")">@b.Status</span></div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-muted">Không có đặt phòng gần đây.</div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function(){
        try{ var t = document.querySelectorAll('[data-bs-toggle="tooltip"]'); if(t) t.forEach(function(el){ new bootstrap.Tooltip(el); }); }catch(e){}
    })();
</script>
