@model QuanLiKhachSan.ViewModels.Admin.DashboardViewModel
@{
    ViewData["Title"] = "Bảng điều khiển";
    Layout = "_AdminLayout";

    // defensive model alias
    var M = Model ?? new QuanLiKhachSan.ViewModels.Admin.DashboardViewModel();
}

@functions {
    private string GetStatusBadgeClass(string status)
    {
        if (string.IsNullOrWhiteSpace(status)) return "badge bg-secondary";
        return status.ToLowerInvariant() switch
        {
            var s when s.Contains("pending") || s.Contains("chờ") => "badge bg-warning text-dark",
            var s when s.Contains("confirmed") || s.Contains("xác nhận") => "badge bg-primary",
            var s when s.Contains("completed") || s.Contains("hoàn thành") => "badge bg-success",
            var s when s.Contains("cancelled") || s.Contains("hủy") => "badge bg-danger",
            _ => "badge bg-secondary"
        };
    }
}

<div class="admin-dashboard container-fluid">
    <div class="dashboard-header d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0">Bảng điều khiển</h1>
            <p class="text-muted small mt-1">Tổng quan hoạt động và thống kê hệ thống</p>
        </div>

        <form method="get" id="dashboardFilters" class="d-flex gap-2 align-items-center">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar-alt" aria-hidden="true"></i></span>
                <input id="start" name="start" class="form-control" value="@(M.FilterStart?.ToString("yyyy-MM-dd") ?? "")" placeholder="Từ" aria-label="Start date" />
            </div>
            <div class="input-group">
                <input id="end" name="end" class="form-control" value="@(M.FilterEnd?.ToString("yyyy-MM-dd") ?? "")" placeholder="Đến" aria-label="End date" />
            </div>

            <select name="status" class="form-select">
                <option value="">Tất cả trạng thái</option>
                @foreach (var kv in (M.BookingsByStatus ?? Enumerable.Empty<KeyValuePair<string,int>>()))
                {
                    <option value="@kv.Key" selected="@((kv.Key == M.FilterStatus).ToString().ToLowerInvariant())">@kv.Key</option>
                }
            </select>

            <button type="submit" class="btn btn-primary">Áp dụng</button>
        </form>
    </div>

    <!-- Metrics -->
    <div class="row g-3 mb-4">
        <div class="col-sm-6 col-xl-3">
            <div class="card metric-card h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-muted small">Doanh thu</div>
                        <div class="h4 mb-0">@M.TotalRevenue.ToString("N0") VNĐ</div>
                        <div class="small text-success mt-1"><i class="fas fa-arrow-up"></i> Tăng so với tháng trước</div>
                    </div>
                    <div class="metric-icon text-muted"><i class="fas fa-wallet fa-2x" aria-hidden="true"></i></div>
                </div>
            </div>
        </div>

        <div class="col-sm-6 col-xl-3">
            <div class="card metric-card h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-muted small">Số đặt phòng</div>
                        <div class="h4 mb-0">@M.TotalBookings</div>
                        <div class="small text-success mt-1"><i class="fas fa-arrow-up"></i> Tăng</div>
                    </div>
                    <div class="metric-icon text-muted"><i class="fas fa-calendar-check fa-2x" aria-hidden="true"></i></div>
                </div>
            </div>
        </div>

        <div class="col-sm-6 col-xl-3">
            <div class="card metric-card h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-muted small">Công suất phòng</div>
                        <div class="h4 mb-0">@M.RoomOccupancyRate.ToString("F1")% </div>
                        <div class="small text-danger mt-1"><i class="fas fa-arrow-down"></i> Giảm</div>
                    </div>
                    <div class="metric-icon text-muted"><i class="fas fa-bed fa-2x" aria-hidden="true"></i></div>
                </div>
            </div>
        </div>

        <div class="col-sm-6 col-xl-3">
            <div class="card metric-card h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-muted small">Khách hàng</div>
                        <div class="h4 mb-0">@M.TotalCustomers</div>
                        <div class="small text-success mt-1">Khách mới</div>
                    </div>
                    <div class="metric-icon text-muted"><i class="fas fa-users fa-2x" aria-hidden="true"></i></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
        <div class="col-xl-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Doanh thu theo tháng</h6>
                    <small class="text-muted">Năm hiện tại</small>
                </div>
                <div class="card-body p-3">
                    <div style="height: 320px;">
                        <canvas id="revenueChart" aria-label="Biểu đồ doanh thu theo tháng"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Tình trạng phòng</h6>
                </div>
                <div class="card-body p-3">
                    <div style="height:200px;">
                        <canvas id="roomStatusChart" aria-label="Biểu đồ tình trạng phòng"></canvas>
                    </div>

                    <div class="room-status-summary mt-3">
                        <div class="row gy-2">
                            <div class="col-6">
                                <div class="status-item">
                                    <div class="status-icon available"><i class="fas fa-check-circle"></i></div>
                                    <div class="status-details">
                                        <div class="h5 mb-0">@M.RoomStatusCounts.Available</div>
                                        <small class="text-muted">Phòng trống</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="status-item">
                                    <div class="status-icon occupied"><i class="fas fa-bed"></i></div>
                                    <div class="status-details">
                                        <div class="h5 mb-0">@M.RoomStatusCounts.Occupied</div>
                                        <small class="text-muted">Đang đặt</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="status-item">
                                    <div class="status-icon cleaning"><i class="fas fa-broom"></i></div>
                                    <div class="status-details">
                                        <div class="h5 mb-0">@M.RoomStatusCounts.Cleaning</div>
                                        <small class="text-muted">Đang dọn</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="status-item">
                                    <div class="status-icon maintenance"><i class="fas fa-tools"></i></div>
                                    <div class="status-details">
                                        <div class="h5 mb-0">@M.RoomStatusCounts.Maintenance</div>
                                        <small class="text-muted">Bảo trì</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent bookings and lists -->
    <div class="row g-3">
        <div class="col-xl-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Đặt phòng gần đây</h6>
                    <a asp-controller="Admin" asp-action="Bookings" class="btn btn-sm btn-primary">Xem tất cả</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Mã</th>
                                    <th>Khách</th>
                                    <th>Phòng</th>
                                    <th>Nhận</th>
                                    <th>Trả</th>
                                    <th>Trạng thái</th>
                                    <th class="text-end">Tổng</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var b in (M.RecentBookings ?? Enumerable.Empty<QuanLiKhachSan.ViewModels.Admin.DashboardViewModel.RecentBookingDto>()).Take(10))
                                {
                                    <tr>
                                        <td>@(b.BookingNumber ?? "-")</td>
                                        <td>@(b.CustomerName ?? "-")</td>
                                        <td>@(b.RoomName ?? "-")</td>
                                        <td>@b.CheckIn.ToString("dd/MM/yyyy")</td>
                                        <td>@b.CheckOut.ToString("dd/MM/yyyy")</td>
                                        <td><span class="@(GetStatusBadgeClass(b.Status))">@b.Status</span></td>
                                        <td class="text-end">@b.TotalPrice.ToString("N0") VNĐ</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Đánh giá gần đây</h6>
                    <a asp-controller="Admin" asp-action="Reviews" class="btn btn-sm btn-primary">Xem tất cả</a>
                </div>
                <div class="card-body p-0">
                    <div class="reviews-list p-3">
                        @foreach (var r in (M.RecentReviews ?? Enumerable.Empty<QuanLiKhachSan.ViewModels.Admin.DashboardViewModel.RecentReviewDto>()).Take(8))
                        {
                            <div class="review-item">
                                <div class="d-flex justify-content-between mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="reviewer-avatar me-2">@r.Initials</div>
                                        <div>
                                            <div class="fw-600">@r.CustomerName</div>
                                            <small class="text-muted">@r.CreatedDate.ToString("dd/MM/yyyy")</small>
                                        </div>
                                    </div>
                                    <div class="text-warning">
                                        @for (int i=1;i<=5;i++) { if (i<=r.Rating) { <i class="fas fa-star"></i>; } else { <i class="far fa-star"></i>; } }
                                    </div>
                                </div>
                                <div class="review-room text-primary small fw-600">@r.RoomName</div>
                                <div class="review-content small text-muted">@r.Comment</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" integrity="" crossorigin="anonymous"></script>
    <script>
        (function(){
            const revenueLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((M.RevenueByMonth ?? new List<QuanLiKhachSan.ViewModels.Admin.DashboardViewModel.RevenuePoint>()).Select(r => r.Label)));
            const revenueData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((M.RevenueByMonth ?? new List<QuanLiKhachSan.ViewModels.Admin.DashboardViewModel.RevenuePoint>()).Select(r => r.Value)));

            const revenueCtx = document.getElementById('revenueChart')?.getContext('2d');
            if (revenueCtx) {
                new Chart(revenueCtx, {
                    type: 'bar',
                    data: { labels: revenueLabels, datasets: [{ label: 'Doanh thu', data: revenueData, backgroundColor: 'rgba(58,110,165,0.9)' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }

            const statusLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((M.BookingsByStatus ?? new List<KeyValuePair<string,int>>()).Select(x=>x.Key)));
            const statusData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((M.BookingsByStatus ?? new List<KeyValuePair<string,int>>()).Select(x=>x.Value)));
            const roomStatusCtx = document.getElementById('roomStatusChart')?.getContext('2d');
            if (roomStatusCtx) {
                new Chart(roomStatusCtx, { type: 'pie', data: { labels: statusLabels.length?statusLabels:['Trống','Đã đặt','Đang dọn dẹp','Bảo trì'], datasets:[{ data: statusData.length?statusData:[M.RoomStatusCounts.Available,M.RoomStatusCounts.Occupied,M.RoomStatusCounts.Cleaning,M.RoomStatusCounts.Maintenance], backgroundColor: ['#1cc88a','#f6c23e','#36b9cc','#e74a3b'] }] }, options:{ responsive:true, maintainAspectRatio:false } });
            }
        })();
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-dashboard.css" asp-append-version="true" />
}