@model QuanLiKhachSan.ViewModels.Booking.BookingViewModel
@{
    ViewData["Title"] = "Đặt phòng";
}

<!-- Booking Header -->
<div class="booking-banner">
    <div class="overlay"></div>
    <div class="container">
        <div class="banner-content">
            <h1>Đặt phòng</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Rooms">Phòng</a></li>
                    <li class="breadcrumb-item"><a asp-controller="Rooms" asp-action="Details" asp-route-id="@Model.RoomId">@Model.RoomName</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Đặt phòng</li>
                </ol>
            </nav>
        </div>
    </div>
</div>

<div class="booking-container">
    <div class="container py-5">
        <div class="row">
            <!-- Booking Form -->
            <div class="col-lg-8">
                <div class="booking-form-container">
                    <div class="booking-steps mb-4">
                        <div class="booking-step active">
                            <div class="step-number">1</div>
                            <div class="step-text">Chi tiết đặt phòng</div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="booking-step">
                            <div class="step-number">2</div>
                            <div class="step-text">Thanh toán</div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="booking-step">
                            <div class="step-number">3</div>
                            <div class="step-text">Xác nhận</div>
                        </div>
                    </div>

                    <form id="bookingForm" method="post" asp-action="Create" asp-controller="Bookings">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-4"></div>
                        <input type="hidden" asp-for="RoomId" />
                        <input type="hidden" asp-for="TotalPrice" value="@Model.CalculatedTotalPrice" />

                        <!-- Stay Details Section -->
                        <div class="form-section mb-4">
                            <h3 class="section-title">Thông tin lưu trú</h3>

                            <div class="row mb-3">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label asp-for="CheckInDate" class="form-label">Ngày nhận phòng</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                        <input asp-for="CheckInDate" type="date" class="form-control" required />
                                    </div>
                                    <span asp-validation-for="CheckInDate" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="CheckOutDate" class="form-label">Ngày trả phòng</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                        <input asp-for="CheckOutDate" type="date" class="form-control" required />
                                    </div>
                                    <span asp-validation-for="CheckOutDate" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label asp-for="GuestCount" class="form-label">Số khách</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user-friends"></i></span>
                                        <select asp-for="GuestCount" class="form-select" required>
                                            @for (int i = 1; i <= Model.MaxGuests; i++)
                                            {
                                                <option value="@i">@i người</option>
                                            }
                                        </select>
                                    </div>
                                    <span asp-validation-for="GuestCount" class="text-danger"></span>
                                    <small class="text-muted">Tối đa @Model.MaxGuests người</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="SpecialRequests" class="form-label">Yêu cầu đặc biệt</label>
                                <textarea asp-for="SpecialRequests" class="form-control" rows="3" placeholder="Vui lòng cho chúng tôi biết nếu bạn có yêu cầu đặc biệt (không đảm bảo)"></textarea>
                                <span asp-validation-for="SpecialRequests" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Guest Details Section -->
                        <div class="form-section mb-4">
                            <h3 class="section-title">Thông tin khách hàng</h3>

                            <div class="row mb-3">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label asp-for="FirstName" class="form-label">Tên</label>
                                    <input asp-for="FirstName" type="text" class="form-control" required />
                                    <span asp-validation-for="FirstName" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="LastName" class="form-label">Họ</label>
                                    <input asp-for="LastName" type="text" class="form-control" required />
                                    <span asp-validation-for="LastName" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6 mb-3 mb-md-0">
                                    <label asp-for="Email" class="form-label">Email</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                        <input asp-for="Email" type="email" class="form-control" required />
                                    </div>
                                    <span asp-validation-for="Email" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="Phone" class="form-label">Số điện thoại</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                        <input asp-for="Phone" type="tel" class="form-control" required />
                                    </div>
                                    <span asp-validation-for="Phone" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="form-section mb-4">
                            <h3 class="section-title">Phương thức thanh toán</h3>

                            <div class="payment-methods">
                                <div class="form-check payment-method-item active">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="payment-hotel" value="pay-at-hotel" checked>
                                    <label class="form-check-label" for="payment-hotel">
                                        <span class="payment-icon"><i class="fas fa-hotel"></i></span>
                                        <div class="payment-info">
                                            <h6>Thanh toán tại khách sạn</h6>
                                            <p>Thanh toán khi nhận phòng - không cần thanh toán trước</p>
                                        </div>
                                    </label>
                                </div>

                                <div class="form-check payment-method-item">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="payment-card" value="credit-card">
                                    <label class="form-check-label" for="payment-card">
                                        <span class="payment-icon"><i class="far fa-credit-card"></i></span>
                                        <div class="payment-info">
                                            <h6>Thẻ tín dụng / Ghi nợ</h6>
                                            <p>Thanh toán an toàn và được bảo mật</p>
                                            <div class="payment-cards">
                                                <i class="fab fa-cc-visa"></i>
                                                <i class="fab fa-cc-mastercard"></i>
                                                <i class="fab fa-cc-amex"></i>
                                            </div>
                                        </div>
                                    </label>
                                </div>

                                <div class="form-check payment-method-item">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="payment-banking" value="bank-transfer">
                                    <label class="form-check-label" for="payment-banking">
                                        <span class="payment-icon"><i class="fas fa-university"></i></span>
                                        <div class="payment-info">
                                            <h6>Chuyển khoản ngân hàng</h6>
                                            <p>Thanh toán bằng chuyển khoản trực tiếp</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div id="creditCardForm" class="card-details mt-3" style="display: none;">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <label class="form-label">Tên trên thẻ</label>
                                        <input type="text" class="form-control" placeholder="VD: NGUYEN VAN A">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <label class="form-label">Số thẻ</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="1234 5678 9012 3456">
                                            <span class="input-group-text"><i class="far fa-credit-card"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3 mb-md-0">
                                        <label class="form-label">Ngày hết hạn</label>
                                        <input type="text" class="form-control" placeholder="MM/YY">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Mã bảo mật (CVV)</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="123">
                                            <span class="input-group-text"><i class="fas fa-question-circle"></i></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="bankTransferInfo" class="bank-details mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <h6 class="mb-2">Thông tin chuyển khoản:</h6>
                                    <p class="mb-1">Tên ngân hàng: Vietcombank</p>
                                    <p class="mb-1">Số tài khoản: 1234567890</p>
                                    <p class="mb-1">Chủ tài khoản: CÔNG TY LUXURY HOTEL</p>
                                    <p class="mb-1">Nội dung chuyển khoản: BOOKING-[Họ và tên]</p>
                                    <p class="mb-0"><strong>Lưu ý:</strong> Vui lòng chuyển khoản trong vòng 24 giờ sau khi đặt phòng để xác nhận đặt phòng.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="form-section mb-4">
                            <div class="form-check mb-3">
                                    <input class="form-check-input" asp-for="AcceptTerms" />
                                    <label class="form-check-label" for="AcceptTerms">
                                        Tôi đồng ý với <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Điều khoản và Điều kiện</a> của Luxury Hotel
                                    </label>
                                    <span asp-validation-for="AcceptTerms" class="text-danger"></span>
                                </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="newsletterSubscribe">
                                <label class="form-check-label" for="newsletterSubscribe">
                                    Tôi muốn nhận các tin tức và ưu đãi đặc biệt qua email
                                </label>
                            </div>
                        </div>

                        <div class="form-actions text-end">
                            <a href="javascript:history.back()" class="btn btn-outline-secondary me-2">Quay lại</a>
                                @if (!Model.IsAvailable)
                                {
                                    <div class="alert alert-danger d-inline-block me-2">Phòng không khả dụng trong khoảng ngày đã chọn.</div>
                                }
                                <button type="submit" class="btn btn-primary" @(Model.IsAvailable ? "" : "disabled=\"disabled\"")>Hoàn tất đặt phòng</button>

                        </div>
                    </form>
                </div>
            </div>

            <!-- Booking Summary -->
            <div class="col-lg-4">
                <div class="booking-summary">
                    <h3 class="summary-title">Thông tin đơn đặt phòng</h3>

                    <div class="room-info">
                        <div class="room-image">
                            <img src="@Model.RoomImageUrl" alt="@Model.RoomName">
                        </div>
                        <div class="room-name">@Model.RoomName</div>
                        <div class="room-type">@Model.RoomType</div>
                    </div>

                    <div class="booking-info">
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-calendar-alt"></i> Nhận phòng</div>
                            <div class="info-value" id="summary-checkin">@Model.CheckInDate.ToString("dd/MM/yyyy")</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-calendar-alt"></i> Trả phòng</div>
                            <div class="info-value" id="summary-checkout">@Model.CheckOutDate.ToString("dd/MM/yyyy")</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-moon"></i> Số đêm</div>
                            <div class="info-value" id="summary-nights">@Model.NightCount</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label"><i class="fas fa-user-friends"></i> Số khách</div>
                            <div class="info-value" id="summary-guests">@Model.GuestCount người</div>
                        </div>
                    </div>

                    <hr class="summary-divider">

                    <div class="price-breakdown">
                        <div class="price-item">
                            <div class="price-label">Giá phòng (@Model.NightCount đêm)</div>
                            <div class="price-value" id="summary-room-price">@((Model.RoomPrice * Model.NightCount).ToString("N0")) VNĐ</div>
                        </div>
                        <div class="price-item">
                            <div class="price-label">Phí dịch vụ</div>
                            <div class="price-value" id="summary-service-fee">@((Model.RoomPrice * Model.NightCount * 0.05m).ToString("N0")) VNĐ</div>
                        </div>
                        <div class="price-item">
                            <div class="price-label">Thuế</div>
                            <div class="price-value" id="summary-tax">@((Model.RoomPrice * Model.NightCount * 0.1m).ToString("N0")) VNĐ</div>
                        </div>
                        @if (Model.Discount > 0)
                        {
                            <div class="price-item discount">
                                <div class="price-label">Giảm giá thành viên</div>
                                <div class="price-value" id="summary-discount">-@((Model.Discount).ToString("N0")) VNĐ</div>
                            </div>
                        }
                    </div>

                    <div class="total-price">
                        <div class="total-label">Tổng cộng</div>
                        <div class="total-value" id="summary-total">@Model.TotalPrice.ToString("N0") VNĐ</div>
                    </div>

                    <div class="summary-note">
                        <i class="fas fa-info-circle"></i>
                        <span>Giá đã bao gồm thuế và phí dịch vụ</span>
                    </div>

                    <div class="cancellation-policy">
                        <h6><i class="fas fa-undo-alt"></i> Chính sách hủy phòng:</h6>
                        <p>Miễn phí hủy phòng trước 72 giờ. Hủy muộn hơn sẽ bị tính phí 1 đêm.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Terms and Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Điều khoản và Điều kiện</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>1. Đặt phòng và thanh toán</h6>
                <p>Để đảm bảo đặt phòng, khách hàng cần thanh toán đầy đủ hoặc đặt cọc theo quy định của khách sạn. Khách sạn có quyền hủy đặt phòng nếu không nhận được thanh toán đúng hạn.</p>

                <h6>2. Nhận phòng và trả phòng</h6>
                <p>Giờ nhận phòng tiêu chuẩn là 14:00 và giờ trả phòng là 12:00. Nhận phòng sớm hoặc trả phòng muộn có thể phát sinh phí bổ sung.</p>

                <h6>3. Hủy đặt phòng</h6>
                <p>Việc hủy đặt phòng phải được thực hiện ít nhất 72 giờ trước ngày nhận phòng để được hoàn tiền đầy đủ. Hủy muộn hơn sẽ bị tính phí một đêm đầu tiên.</p>

                <h6>4. Quy định chung</h6>
                <p>Khách hàng phải tuân thủ nội quy của khách sạn trong suốt thời gian lưu trú. Khách sạn có quyền từ chối phục vụ hoặc yêu cầu khách rời đi mà không hoàn tiền nếu khách vi phạm nghiêm trọng nội quy.</p>

                <h6>5. Trách nhiệm</h6>
                <p>Khách sạn không chịu trách nhiệm cho bất kỳ mất mát, hư hỏng hoặc trộm cắp tài sản cá nhân của khách trong thời gian lưu trú. Khách hàng chịu trách nhiệm bồi thường cho bất kỳ thiệt hại nào gây ra cho tài sản của khách sạn.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đồng ý</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle payment method selection
            const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
            const creditCardForm = document.getElementById('creditCardForm');
            const bankTransferInfo = document.getElementById('bankTransferInfo');

            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    // Reset all payment method items
                    document.querySelectorAll('.payment-method-item').forEach(item => {
                        item.classList.remove('active');
                    });

                    // Add active class to selected method
                    this.closest('.payment-method-item').classList.add('active');

                    // Show/hide appropriate form
                    if (this.value === 'credit-card') {
                        creditCardForm.style.display = 'block';
                        bankTransferInfo.style.display = 'none';
                    } else if (this.value === 'bank-transfer') {
                        creditCardForm.style.display = 'none';
                        bankTransferInfo.style.display = 'block';
                    } else {
                        creditCardForm.style.display = 'none';
                        bankTransferInfo.style.display = 'none';
                    }
                });
            });

            // Update booking summary when dates change
            const checkinInput = document.querySelector('input[name="CheckInDate"]');
            const checkoutInput = document.querySelector('input[name="CheckOutDate"]');
            const guestInput = document.querySelector('select[name="GuestCount"]');

            if (checkinInput && checkoutInput) {
                checkinInput.addEventListener('change', updateBookingSummary);
                checkoutInput.addEventListener('change', updateBookingSummary);
                guestInput.addEventListener('change', updateGuestCount);
            }

            function updateBookingSummary() {
                const checkin = new Date(checkinInput.value);
                const checkout = new Date(checkoutInput.value);

                if (checkin && checkout && checkout > checkin) {
                    // Calculate night count
                    const timeDiff = checkout.getTime() - checkin.getTime();
                    const nightCount = Math.ceil(timeDiff / (1000 * 3600 * 24));

                    // Update summary elements
                    document.getElementById('summary-checkin').textContent = formatDate(checkin);
                    document.getElementById('summary-checkout').textContent = formatDate(checkout);
                    document.getElementById('summary-nights').textContent = nightCount;

                    // Update prices
                    const roomPrice = @Json.Serialize(Model.RoomPrice);
                    const roomTotal = roomPrice * nightCount;
                    const serviceFee = roomTotal * 0.05;
                    const tax = roomTotal * 0.10;
                    const discount = @Json.Serialize(Model.Discount);
                    const total = roomTotal + serviceFee + tax - discount;

                    document.getElementById('summary-room-price').textContent = formatCurrency(roomTotal);
                    document.getElementById('summary-service-fee').textContent = formatCurrency(serviceFee);
                    document.getElementById('summary-tax').textContent = formatCurrency(tax);

                    if (discount > 0) {
                        document.getElementById('summary-discount').textContent = '-' + formatCurrency(discount);
                    }

                    document.getElementById('summary-total').textContent = formatCurrency(total);
                }
            }

            function updateGuestCount() {
                document.getElementById('summary-guests').textContent = guestInput.value + ' người';
            }

            function formatDate(date) {
                return date.getDate().toString().padStart(2, '0') + '/' +
                      (date.getMonth() + 1).toString().padStart(2, '0') + '/' +
                       date.getFullYear();
            }

            function formatCurrency(value) {
                return new Intl.NumberFormat('vi-VN', {
                    maximumFractionDigits: 0
                }).format(value) + ' VNĐ';
            }
        });
    </script>

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}

<script>
    // Extra client-side guard: ensure AcceptTerms is checked before allowing submit
    (function() {
        const form = document.getElementById('bookingForm');
        if (!form) return;

        const acceptCheckbox = document.querySelector('input[type="checkbox"][name="AcceptTerms"]');
        const validationSpan = document.querySelector('[data-valmsg-for="AcceptTerms"]');
        const submitButton = form.querySelector('button[type="submit"]');

        function showValidationMessage(message) {
            if (validationSpan) {
                validationSpan.textContent = message;
                validationSpan.classList.add('field-validation-error');
            } else {
                alert(message);
            }
        }

        function clearValidationMessage() {
            if (validationSpan) {
                validationSpan.textContent = '';
                validationSpan.classList.remove('field-validation-error');
            }
        }

        // When checkbox changes, clear any validation message and enable submit
        if (acceptCheckbox) {
            acceptCheckbox.addEventListener('change', function () {
                if (acceptCheckbox.checked) {
                    clearValidationMessage();
                    if (submitButton) submitButton.removeAttribute('disabled');
                }
            });
        }

        // Ensure the hidden input (generated by the checkbox TagHelper) mirrors the visible checkbox value
        const acceptHidden = document.querySelector('input[type="hidden"][name="AcceptTerms"]');
        function syncAcceptHidden() {
            if (acceptHidden && acceptCheckbox) {
                acceptHidden.value = acceptCheckbox.checked ? 'true' : 'false';
            }
        }

        if (acceptCheckbox) {
            // sync initially and on every change
            syncAcceptHidden();
            acceptCheckbox.addEventListener('change', syncAcceptHidden);
        }

        form.addEventListener('submit', function (e) {
            // If the checkbox exists and is not checked, block submit and show message
            // Always sync hidden input before validation/submit
            syncAcceptHidden();

            if (acceptCheckbox && !acceptCheckbox.checked) {
                e.preventDefault();
                showValidationMessage('Bạn phải đồng ý với Điều khoản và Điều kiện');
                acceptCheckbox.focus();
                return false;
            }

            // If checkbox present and checked, ensure any leftover validation message is cleared
            if (acceptCheckbox && acceptCheckbox.checked) {
                clearValidationMessage();
            }
        });
    })();
</script>

@section Styles {
    <link rel="stylesheet" href="~/css/booking.css" asp-append-version="true" />
}